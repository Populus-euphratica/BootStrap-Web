<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    type="text/css">
  <link rel="stylesheet" href="../css/bootstrap-4.3.1.css">
  <script src="../jquery/jquery-3.4.1.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
    <div class="container"> <button class="navbar-toggler navbar-toggler-right border-0" type="button"
        data-toggle="collapse" data-target="#navbar12">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar12"> <a class="navbar-brand d-none d-md-block" href="#">
          <i class="fa d-inline fa-lg fa-circle"></i>
          <b> BRAND</b>
        </a>
        <ul class="navbar-nav mx-auto">
          <li class="nav-item"> <a class="nav-link" href="#">API管理</a> </li>
          <li class="nav-item"> <a class="nav-link" href="#">用户管理</a> </li>
          <li class="nav-item"> <a class="nav-link" href="#">新闻管理</a> </li>
          <li class="nav-item"><a class="nav-link" href="#">综合数据</a></li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item"> <a class="nav-link text-primary" href="#"><i class="fa fa-bell-o"
                aria-hidden="true"></i>Message</a> </li>
          <li class="nav-item"> <a class="nav-link text-primary" href="#"><i class="fa fa-user fa-fw"></i>Log in</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="row">
            <div class="col-4">
              <div class="list-group" id="list-tab" role="tablist">
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center active"
                  id="list-comingApply-list" data-toggle="list" href="#list-comingApply" role="tab" aria-controls="home"
                  aria-selected="true" data-operation="comingApply">申请管理员 </a>
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  id="list-alreadyApply-list" data-toggle="list" href="#list-alreadyApply" role="tab"
                  aria-controls="profile" aria-selected="false" data-operation="alreadyApply">已处理申请 </a>
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  id="list-comingFeedBack-list" data-toggle="list" href="#list-comingFeedBack" role="tab"
                  aria-controls="profile" aria-selected="false" data-operation="comingFeedBack">未处理反馈 </a>
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  id="list-alreadyFeedBack-list" data-toggle="list" href="#list-alreadyFeedBack" role="tab"
                  aria-controls="profile" aria-selected="false" data-operation="alreadyFeedBack">已处理反馈 </a>
              </div>
            </div>
            <div class="col-8">
              <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade active show" id="list-comingApply" role="tabpanel"
                  aria-labelledby="list-comingApply-list"></div>
                <div class="tab-pane fade" aria-labelledby="list-alreadyApply-list" id="list-alreadyApply"
                  role="tabpanel">
                </div>
                <div class="tab-pane fade" id="list-comingFeedBack" role="tabpanel"
                  aria-labelledby="list-comingFeedBack-list"></div>
                <div class="tab-pane fade" aria-labelledby="list-alreadyFeedBack-list" id="list-alreadyFeedBack"
                  role="tabpanel">..2
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">回复</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text">回复内容：</span>
              </div>
              <textarea class="form-control" aria-label="With textarea" id="replyContent" rows="10"
                placeholder="回复内容"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="determine" class="btn btn-outline-primary btn-block"
              data-dismiss="modal">确定</button>
          </div>

        </div>
      </div>
    </div>





    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
      integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"
      style=""></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"
      style=""></script>
</body>
<script>
  // 定义全局变量方便下面进行页面刷新和实现页面跳转
  var pageNum = 1;
  var searchUrl = "";
  var searchType = "";
  var data1 = "";
  var updatePlace;
  var replyContent = $("#replyContent");
  var updateFalg = true;
  var updateStr = "footerParentComingApply";
  $(document).ready(messageManage());
  $(document).ready(messageInit());
  $(document).ready(numInit());
  $(document).ready(clickApply());
  $(document).ready(clickFeedBack());

  // 激发未处理申请事件
  function messageInit() {
    $("#list-comingApply-list").click();
  }
  // 切换面板时更新显示区域
  function messageManage() {
    $("#list-tab").click(function (event) {
      var operation = $(event.target).data("operation");
      pageNum = 1;
      if (operation == "comingApply") {
        searchUrl = "http://localhost:8080/api/applyForAdmin/istrue";
        searchType = "get";
        data1 = {
          istrue: false,
          pageNum: pageNum
        }
        updateFalg = true;
        updateStr = "footerParentComingApply";
        updatePlace = $("#list-comingApply");
        updateApply();
      } else if (operation == "alreadyApply") {
        searchUrl = "http://localhost:8080/api/applyForAdmin/istrue";
        searchType = "get";
        data1 = {
          istrue: true,
          pageNum: pageNum
        }
        updateFalg = true;
        updatePlace = $("#list-alreadyApply");
        updateStr = "footerParentAlreadyApply";
        updateApply();
      } else if (operation == "comingFeedBack") {
        searchUrl = "http://localhost:8080/api/feedBack/istrue";
        searchType = "get";
        data1 = {
          istrue: false,
          pageNum: pageNum
        }
        updateFalg = false;
        updatePlace = $("#list-comingFeedBack");
        updateStr = "footerParentComingFeedBack";
        updateFeedBack();
      } else if (operation == "alreadyFeedBack") {
        searchUrl = "http://localhost:8080/api/feedBack/istrue";
        searchType = "get";
        data1 = {
          istrue: true,
          pageNum: pageNum
        }
        updateFalg = false;
        updatePlace = $("#list-alreadyFeedBack");
        updateStr = "footerParentAlreadyFeedBack";
        updateFeedBack();
      }
    })
  }
  // 初始化未处理消息数目
  function numInit() {
    $.ajax({
      url: "http://localhost:8080/api/applyForAdmin/istrue/sum",
      type: "get",
      data: {
        "istrue": false
      },
      success: function (data) {
        if (data > 0) {
          $("#list-comingApply-list").append("<span class='badge badge-success badge-pill'>" + data + "</span>");
        }
      }
    });
    $.ajax({
      url: "http://localhost:8080/api/feedBack/istrue/sum",
      type: "get",
      data: {
        "istrue": false
      },
      success: function (data) {
        if (data > 0) {
          $("#list-comingFeedBack-list").append("<span class='badge badge-success badge-pill'>" + data + "</span>");
        }
      }
    });


  }


  // 更新申请面板内容
  function updateApplyContent(list) {
    var content = "";
    $.each(list, function (i, val) {
      content += "<div class='col-md-12 pb-3'><div class='card'><div class='card-body'><div class='d-flex w-100 justify-content-between'><h5 class='card-title'><strong>" + "申请管理员" + "</strong></h5>"
        + "<small>" + val.date + "</small></div><div class='d-flex w-100 justify-content-between'><p>名称：" + val.name + "</p><p>邮箱：" + val.email + "</p><p>密码：" + val.password + "</p></div>"
        + "<p class='card-text'>理由：" + val.reason + "</p><div name='chooseApply' class='row justify-content-end' data-id='" + val.id + "'data-name='" + val.name + "'data-email='" + val.email + "'data-password='"
        + val.password + "'><a href='#' data-agree-apply='yes' class='card-link'>同意</a><a href='#' data-agree-apply='no' class='card-link mr-3'>拒绝</a></div></div></div></div>";

    })
    content += "<div id='" + updateStr + "'></div>";
    return content;
  }

  // 更新反馈面板内容
  function updateFeedBackContent(list) {
    var content = "";
    $.each(list, function (i, val) {
      content += "<div class='col-md-12 pb-3'><div class='card'><div class='card-body'><div class='d-flex w-100 justify-content-between'><h5 class='card-title'><strong>" + val.theme + "</strong></h5>"
        + "<small>" + val.date + "</small></div><p class='card-text'>反馈内容：" + val.content + "</p><div  class='row justify-content-end'><p class='text-muted'>——来自" + val.company + "的" + val.name + "</p></div>"
        + "<div  class='row justify-content-end' data-id='" + val.id + "' data-email='" + val.email + "'><a href='#' data-agree-reply='yes' class='card-link'>回复</a><a href='#' data-agree-reply='no' class='card-link'>忽略</a></div></div></div></div>";
    })

    content += "<div id='" + updateStr + "'></div>";
    return content;
  }
  // 申请面板点击处理逻辑
  function clickApply() {
    $(document).on("click", "a[data-agree-apply]", function () {
      var apply = $(this.parentNode);
      var choose = $(this).data("agree-apply");
      var str = "";
      var istrue = true;
      if (choose === "yes") {
        str = "恭喜您，经过我们审核，您满足成为管理员的条件，您现已获得管理员身份！";
        istrue = true;
      } else {
        str = "对不起，经过我们审核，您尚不满足成为管理员的条件！";
        istrue = false;
      }
      replyContent.val(str);
      applyManage(apply, istrue);
    })
  }

  // 反馈面板点击处理逻辑
  function clickFeedBack() {
    $(document).on("click", "a[data-agree-reply]", function () {
      var apply = $(this.parentNode);
      var choose = $(this).data("agree-reply");
      var id = apply.data("id");
      var email = apply.data("email");
      var istrue = true;
      if (choose === "yes") {
        istrue = true;
      } else {
        istrue = false;
      }
      replyContent.val("我们很重视您的反馈，我们会认真考虑并作出改进的！再次感谢您提出的宝贵意见。")
      feedBackManage(email, istrue, id);

    })
  }
  // 实现发送邮件以及更新feedBack数据库记录
  function feedBackManage(email, istrue, id) {
    $('#exampleModal').modal('show');
    $("#determine").click(function () {
      if (!istrue) {
        replyContent.val("")
      }
      $.ajax({
        url: "http://localhost:8080/api/feedBack/reply",
        type: "put",
        data: {
          "reply": replyContent.val(),
          "id": id
        },
        success: function (falg) {
          if (falg) {
            alert("添加成功!");
            if (!istrue) {
              return;
            }
            var emailData = {
              "content": replyContent.val(),
              "to": email
            };
            sendEmail(emailData);
          } else {
            alert("更新失败!");
          }
        }, error: function () {
          alert("连接服务器失败")
        }
      })

    })

  }
  // 实现发送邮件以及更新apply数据库记录
  function applyManage(apply, istrue) {
    $('#exampleModal').modal('show');
    $("#determine").off();
    $("#determine").click(function () {
      if (istrue) {
        $.ajax({
          url: "http:localhost:8080/api/admin/email",
          type: "get",
          data: {
            "email": $.trim(apply.data("email"))
          },
          success: function (emailDate) {
            if (emailDate.id != null) {
              emailNote.text("该邮箱已被其他人使用");
              email.focus();
              return;
            } else {

              var adminData = {
                "name": apply.data("name"),
                "email": apply.data("email"),
                "password": apply.data("password")
              };
              $.ajax({
                url: "http://localhost:8080/api/admin/apply?decide=true&id=" + apply.data("id"),
                type: "post",
                data: JSON.stringify(adminData),
                contentType: "application/json;charset=utf-8",
                // dataType: "json",
                success: function (falg) {
                  if (falg) {
                    alert("添加成功!");
                    var emailData = {
                      "content": replyContent.val(),
                      "to": apply.data("email")
                    };
                    sendEmail(emailData);
                  } else {
                    alert("添加失败!");
                  }
                },
                error: function () {
                  alert("连接服务器失败!");
                }
              })
            }
          },
          error: function () {
            alert("连接服务器失败!");
          }
        })

      }
      else {

        $.ajax({
          url: "http://localhost:8080/api/applyForAdmin/id",
          type: "put",
          data: {
            "decide": false,
            "id": apply.data("id")
          },
          success: function (falg) {
            if (falg) {
              alert("操作成功！")
            } else {
              alert("操作失败！")
            }
          },
          error: function () {
            alert("连接服务器失败!");
          }
        })
        var emailData = {
          "content": replyContent.val(),
          "to": apply.data("email")
        };
        sendEmail(emailData);
      }
    })
  }


  // 发送邮件
  function sendEmail(data) {
    console.log(data)
    $.ajax({
      url: "http://localhost:8080/api/email/",
      type: "post",
      data: data,
      success: function (falg) {
        if (falg) {
          alert("成功发送邮件！");
        } else {
          alert("发送邮件失败！");
        }
      },
      error: function () {
        alert("连接服务器失败！");
      }
    })
  }

  function updateManage() {
    if (updateFalg) {
      updateApply()
    } else {
      updateFeedBack()
    }
  }

  // 获取申请的分页数据
  function updateApply() {
    $.ajax({
      url: searchUrl,
      type: searchType,
      data: data1,
      success: function (data) {
        if (data.total != 0) {
          updatePlace.html(updateApplyContent(data.list, updateStr));

          if (data.pages > 1) {
            footerContent(data.pageNum, data.hasPreviousPage, data.hasNextPage, data.navigatepageNums, $("#" + updateStr + ""));
            footerEnterAPI();
          }
        } else {
          updatePlace.html("<h1>这里什么都没有，去别的地方看看吧</h1>");
        }
      },
      error: function () {
        return false;
      }
    })
  }
  // 获取反馈的分页数据
  function updateFeedBack() {
    $.ajax({
      url: searchUrl,
      type: searchType,
      data: data1,
      success: function (data) {
        if (data.total != 0) {
          updatePlace.html(updateFeedBackContent(data.list, updateStr));
          if (data.pages > 1) {
            footerContent(data.pageNum, data.hasPreviousPage, data.hasNextPage, data.navigatepageNums, $("#" + updateStr + ""));
            footerEnterAPI();
          }
        } else {
          updatePlace.html("<h1>这里什么都没有，去别的地方看看吧</h1>");
        }
      }
    })
  }

  // 实现页脚在界面的显示
  function footerContent(pageNum, hasPreviousPage, hasNextPage, navigatepageNums, footer) {
    var content = "<ul class='pagination justify-content-center' data-footer='footer'>";
    if (!hasPreviousPage) {
      $.each(navigatepageNums, function (i, val) {
        if (i == 0) {
          content += "<li class='page-item active'> <a class='page-link' href='#' data-pagenum=" + val + ">" + val + "</a></li>"
        } else if (i <= 3) {
          content += "<li class='page-item'> <a class='page-link' href='#' data-pagenum=" + val + ">" + val + "</a></li>"
        } else {
          content += "<li class='page-item'> <a class='page-link' href='#'  data-pagenum=" + val + ">" + "Next" + "</a></li>"
        }
      })
    } else if (!hasNextPage) {
      $.each(navigatepageNums, function (i, val) {
        if (i == 0) {
          content += "<li class='page-item'> <a class='page-link' href='#' data-pagenum=" + val + ">" + "Prev" + "</a></li>"
        } else if (i < Object.keys(navigatepageNums).length - 1) {
          content += "<li class='page-item'> <a class='page-link' href='#' data-pagenum=" + val + ">" + val + "</a></li>"
        } else {
          content += "<li class='page-item active'> <a class='page-link' href='#' data-pagenum=" + val + ">" + val + "</a></li>"
        }
      })
    } else {
      $.each(navigatepageNums, function (i, val) {
        if (i == 0) {
          content += "<li class='page-item'> <a class='page-link'  href='#' data-pagenum=" + val + ">" + "Prev" + "</a></li>"
        } else if (i < 4) {
          if (val != pageNum) {
            content += "<li class='page-item' > <a class='page-link'  href='#' data-pagenum=" + val + ">" + val + "</a></li>"
          } else {
            content += "<li class='page-item active'> <a class='page-link' href='#' data-pagenum=" + val + ">" + val + "</a>								</li>"
          }
        } else {
          content += "<li class='page-item'> <a class='page-link'  href='#' data-pagenum=" + val + ">" + "Next" + "</a></li>"
        }
      })
    }
    content += "</ul>";
    footer.html(content)
  }
  // 实现根据页脚进行跳转的功能
  function footerEnterAPI() {
    $("ul[data-footer]").click(function (event) {
      pageNum = $(event.target).data("pagenum");
      data1.pageNum = pageNum;
      reFresh();
    })
  }
  // 刷新界面
  function reFresh() {

    if (!updateManage()) {
      updatePlace.html("");
    }
  }
</script>

</html>